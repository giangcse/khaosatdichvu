<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Kh·∫£o s√°t - Vƒ©nh Long</title>
    <!-- PWA Meta Tags -->
    <meta name="description" content="Dashboard th·ªëng k√™ kh·∫£o s√°t d·ªãch v·ª• cho X√£/Ph∆∞·ªùng">
    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Dashboard VNPT">
    
    <!-- Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%234f46e5'%3E%3Cpath d='M3 3h18v18H3V3zm2 2v14h14V5H5zm2 2h10v2H7V7zm0 4h7v2H7v-2zm0 4h10v2H7v-2z'/%3E%3C/svg%3E">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        .chart-container-large {
            position: relative;
            height: 400px;
            width: 100%;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .stat-card.green {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .stat-card.blue {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .stat-card.orange {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .stat-card.purple {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        /* Loading animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .table-scroll {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .progress-bar {
            transition: width 0.3s ease;
        }
        
        /* Sort indicators */
        .sort-header {
            position: relative;
        }
        
        .sort-header.active::after {
            content: '';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
        }
        
        .sort-header.active.asc::after {
            border-bottom: 6px solid #6b7280;
        }
        
        .sort-header.active.desc::after {
            border-top: 6px solid #6b7280;
        }
        
        /* Enhanced search input */
        .search-highlight {
            background-color: #fef3c7;
            padding: 1px 2px;
            border-radius: 2px;
        }
        
        /* Filter badges */
        .filter-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            margin: 2px;
            background-color: #ddd6fe;
            color: #5b21b6;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .filter-badge button {
            margin-left: 4px;
            background: none;
            border: none;
            color: #5b21b6;
            cursor: pointer;
            font-size: 12px;
        }
    </style>
</head>

<body class="bg-gray-50">
    <!-- Navigation Header -->
    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-bold text-gray-900">Dashboard Kh·∫£o s√°t</h1>
                    <span class="ml-2 text-sm text-gray-500">Vƒ©nh Long</span>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="window.open('/map', '_blank')" 
                            class="text-gray-500 hover:text-gray-700 px-3 py-2 rounded-md text-sm font-medium">
                        B·∫£n ƒë·ªì
                    </button>
                    <button onclick="window.open('/', '_blank')" 
                            class="text-gray-500 hover:text-gray-700 px-3 py-2 rounded-md text-sm font-medium">
                        Form kh·∫£o s√°t
                    </button>
                    <button id="refreshBtn" 
                            class="bg-indigo-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-indigo-700 transition-colors">
                        <span id="refreshText">L√†m m·ªõi</span>
                        <span id="refreshSpinner" class="loading hidden"></span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Loading State -->
        <div id="loadingState" class="text-center py-12">
            <div class="loading inline-block mb-4"></div>
            <p class="text-gray-600">ƒêang t·∫£i d·ªØ li·ªáu th·ªëng k√™...</p>
        </div>

        <!-- Dashboard Content (Initially Hidden) -->
        <div id="dashboardContent" class="hidden">
            <!-- Overview Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="stat-card green rounded-xl p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-green-100 text-sm font-medium">T·ªïng x√£/ph∆∞·ªùng</p>
                            <p id="totalAreas" class="text-3xl font-bold">-</p>
                            <p class="text-green-100 text-xs mt-1">Theo xaphuong.json</p>
                        </div>
                        <div class="p-3 bg-green-400 bg-opacity-30 rounded-full">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="stat-card blue rounded-xl p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-blue-100 text-sm font-medium">ƒê√£ kh·∫£o s√°t</p>
                            <p id="surveyedAreas" class="text-3xl font-bold">-</p>
                            <p class="text-blue-100 text-xs mt-1">X√£/ph∆∞·ªùng c√≥ d·ªØ li·ªáu</p>
                        </div>
                        <div class="p-3 bg-blue-400 bg-opacity-30 rounded-full">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="stat-card orange rounded-xl p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-pink-100 text-sm font-medium">T·ª∑ l·ªá kh·∫£o s√°t</p>
                            <p id="completionRate" class="text-3xl font-bold">-%</p>
                            <p class="text-pink-100 text-xs mt-1">ƒê√£ kh·∫£o s√°t / 131 t·ªïng</p>
                        </div>
                        <div class="p-3 bg-pink-400 bg-opacity-30 rounded-full">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="stat-card purple rounded-xl p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-cyan-100 text-sm font-medium">T·ªïng d·ªãch v·ª•</p>
                            <p class="text-3xl font-bold">12</p>
                        </div>
                        <div class="p-3 bg-cyan-400 bg-opacity-30 rounded-full">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <!-- Service Overview Pie Chart -->
                <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">T·ªïng quan d·ªãch v·ª•</h3>
                    <div class="chart-container">
                        <canvas id="serviceOverviewChart"></canvas>
                    </div>
                </div>

                <!-- Survey Progress by Area -->
                <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">T·ª∑ l·ªá kh·∫£o s√°t theo ƒë·ªãa b√†n</h3>
                    <p class="text-xs text-gray-600 mb-3">Ph·∫ßn trƒÉm x√£/ph∆∞·ªùng ƒë√£ ƒë∆∞·ª£c kh·∫£o s√°t trong t·ª´ng ƒë·ªãa b√†n</p>
                    <div class="chart-container">
                        <canvas id="diabanChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Service Details Bar Chart -->
            <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200 mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Chi ti·∫øt t·ª´ng d·ªãch v·ª•</h3>
                    <div class="text-xs text-gray-500">
                        <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">‚ÑπÔ∏è Xem ghi ch√∫ b√™n d∆∞·ªõi</span>
                    </div>
                </div>
                <div class="chart-container-large">
                    <canvas id="serviceDetailsChart"></canvas>
                </div>
                <!-- Status Legend -->
                <div class="mt-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <h4 class="text-sm font-medium text-gray-700 mb-3">üîç Ghi ch√∫ v·ªÅ tr·∫°ng th√°i d·ªãch v·ª•:</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-xs">
                        <div class="flex items-center space-x-2">
                            <span class="w-3 h-3 bg-green-500 rounded-full"></span>
                            <span><strong>C√≥:</strong> ƒê√£ tri·ªÉn khai/s·ª≠ d·ª•ng d·ªãch v·ª•</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="w-3 h-3 bg-red-500 rounded-full"></span>
                            <span><strong>Ch∆∞a c√≥ nhu c·∫ßu:</strong> Kh√¥ng c·∫ßn s·ª≠ d·ª•ng d·ªãch v·ª•</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="w-3 h-3 bg-blue-500 rounded-full"></span>
                            <span><strong>Hƒê v·ªõi VNPT:</strong> ƒê√£ c√≥ h·ª£p ƒë·ªìng v·ªõi VNPT</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="w-3 h-3 bg-purple-500 rounded-full"></span>
                            <span><strong>Hƒê v·ªõi ƒë∆°n v·ªã kh√°c:</strong> ƒê√£ c√≥ nh√† cung c·∫•p kh√°c</span>
                        </div>
                    </div>
                    
                    <!-- Detailed explanation -->
                    <div class="mt-4 pt-3 border-t border-gray-300">
                        <h5 class="text-xs font-semibold text-gray-700 mb-2">üìã Chi ti·∫øt theo t·ª´ng d·ªãch v·ª•:</h5>
                        <div class="space-y-2 text-xs text-gray-600">
                            <div class="bg-white p-2 rounded border">
                                <strong>D·ªãch v·ª• 1-6, 9-12:</strong> 
                                C√≥ ‚úÖ (+ input s·ªë l∆∞·ª£ng) | Kh√¥ng ‚ùå ‚Üí Ch·ªçn l√Ω do (VNPT/ƒê∆°n v·ªã kh√°c/Ch∆∞a c√≥ nhu c·∫ßu)
                            </div>
                            <div class="bg-white p-2 rounded border">
                                <strong>D·ªãch v·ª• 4 & 12:</strong> 
                                C√≥ ‚úÖ | Kh√¥ng ‚ùå ‚Üí Ch·ªçn l√Ω do (kh√¥ng c√≥ input s·ªë l∆∞·ª£ng)
                            </div>
                            <div class="bg-white p-2 rounded border">
                                <strong>D·ªãch v·ª• 7 (Camera x√£ ph∆∞·ªùng):</strong> 
                                C√≥ ‚úÖ ‚Üí Ch·ªçn ng√†y h·∫πn kh·∫£o s√°t | Kh√¥ng ‚ùå ‚Üí Ch·ªçn l√Ω do
                            </div>
                            <div class="bg-white p-2 rounded border">
                                <strong>D·ªãch v·ª• 8 (K√™nh TSL CD):</strong> 
                                Dropdown: 1-4 k√™nh = C√≥ ‚úÖ (+ input t·ªëc ƒë·ªô) | Kh√¥ng ‚ùå ‚Üí Ch·ªçn l√Ω do
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Area Details Table -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">Chi ti·∫øt theo t·ª´ng x√£/ph∆∞·ªùng</h3>
                            <p class="text-sm text-gray-600 mt-1">Danh s√°ch x√£/ph∆∞·ªùng v√† t·ª∑ l·ªá ho√†n th√†nh d·ªãch v·ª•</p>
                        </div>
                        <div class="text-sm text-gray-500">
                            <span id="tableStats">Hi·ªÉn th·ªã 0 / 0 k·∫øt qu·∫£</span>
                        </div>
                    </div>
                    
                    <!-- Search and Filter Controls -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                        <!-- Search Box -->
                        <div class="relative">
                            <input type="text" 
                                   id="searchInput" 
                                   placeholder="T√¨m ki·∫øm x√£/ph∆∞·ªùng..." 
                                   class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                            <svg class="absolute left-3 top-2.5 h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        
                        <!-- Filter by Diaban -->
                        <div>
                            <select id="diabanFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                                <option value="">T·∫•t c·∫£ ƒë·ªãa b√†n</option>
                            </select>
                        </div>
                        
                        <!-- Filter by Completion Rate -->
                        <div>
                            <select id="completionFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                                <option value="">T·∫•t c·∫£ t·ª∑ l·ªá</option>
                                <option value="high">Cao (‚â•75%)</option>
                                <option value="medium">Trung b√¨nh (50-74%)</option>
                                <option value="low">Th·∫•p (<50%)</option>
                            </select>
                        </div>
                        
                        <!-- Clear Filters -->
                        <div>
                            <button id="clearFilters" 
                                    class="w-full px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm font-medium">
                                X√≥a b·ªô l·ªçc
                            </button>
                        </div>
                    </div>
                    
                    <!-- Active Filters Display -->
                    <div id="activeFilters" class="hidden mb-3">
                        <div class="flex items-center flex-wrap">
                            <span class="text-xs text-gray-600 mr-2">B·ªô l·ªçc ƒëang √°p d·ª•ng:</span>
                            <div id="filterBadges" class="flex flex-wrap"></div>
                        </div>
                    </div>
                </div>
                
                <div class="table-scroll">
                    <table class="min-w-full">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">STT</th>
                                <th id="header-area_name" class="sort-header px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors" 
                                    onclick="sortTable('area_name')">
                                    <div class="flex items-center space-x-1">
                                        <span>X√£/Ph∆∞·ªùng</span>
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                        </svg>
                                    </div>
                                </th>
                                <th id="header-diaban" class="sort-header px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors" 
                                    onclick="sortTable('diaban')">
                                    <div class="flex items-center space-x-1">
                                        <span>ƒê·ªãa b√†n</span>
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                        </svg>
                                    </div>
                                </th>
                                <th id="header-completed_services" class="sort-header px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors" 
                                    onclick="sortTable('completed_services')">
                                    <div class="flex items-center space-x-1">
                                        <span>D·ªãch v·ª• c√≥</span>
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                        </svg>
                                    </div>
                                </th>
                                <th id="header-completion_rate" class="sort-header px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors" 
                                    onclick="sortTable('completion_rate')">
                                    <div class="flex items-center space-x-1">
                                        <span>T·ª∑ l·ªá ho√†n th√†nh</span>
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                        </svg>
                                    </div>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ti·∫øn ƒë·ªô</th>
                            </tr>
                        </thead>
                        <tbody id="areaTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let dashboardData = null;
        let charts = {};
        let originalAreaData = []; // Store original data for filtering
        let filteredAreaData = []; // Store filtered data
        let currentSortField = '';
        let currentSortDirection = 'asc';

        // Function to destroy all charts
        function destroyAllCharts() {
            Object.values(charts).forEach(chart => {
                if (chart && typeof chart.destroy === 'function') {
                    chart.destroy();
                }
            });
            charts = {};
        }

        // Load dashboard data
        async function loadDashboardData() {
            try {
                showLoading(true);
                // Destroy existing charts before loading new data
                destroyAllCharts();
                
                const response = await fetch('/api/dashboard-stats');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const result = await response.json();
                
                if (result.success) {
                    dashboardData = result;
                    updateOverviewCards();
                    createCharts();
                    populateAreaTable();
                    showDashboard();
                } else {
                    throw new Error(result.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh');
                }
            } catch (error) {
                console.error('L·ªói khi t·∫£i d·ªØ li·ªáu dashboard:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'L·ªói!',
                    text: 'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu dashboard. Vui l√≤ng th·ª≠ l·∫°i.',
                    confirmButtonText: 'Th·ª≠ l·∫°i',
                    confirmButtonColor: '#ef4444'
                }).then(() => {
                    loadDashboardData();
                });
            }
        }

        // Show/hide loading state
        function showLoading(show) {
            const loadingEl = document.getElementById('loadingState');
            const dashboardEl = document.getElementById('dashboardContent');
            
            if (show) {
                loadingEl.classList.remove('hidden');
                dashboardEl.classList.add('hidden');
            } else {
                loadingEl.classList.add('hidden');
                dashboardEl.classList.remove('hidden');
            }
        }

        function showDashboard() {
            showLoading(false);
        }

        // Update overview cards
        function updateOverviewCards() {
            if (!dashboardData?.overview) return;
            
            const overview = dashboardData.overview;
            document.getElementById('totalAreas').textContent = overview.total_areas;
            document.getElementById('surveyedAreas').textContent = overview.surveyed_areas;
            document.getElementById('completionRate').textContent = overview.completion_rate + '%';
        }

        // Create all charts
        function createCharts() {
            // Destroy existing charts before creating new ones
            if (charts.serviceOverview) {
                charts.serviceOverview.destroy();
            }
            if (charts.diaban) {
                charts.diaban.destroy();
            }
            if (charts.serviceDetails) {
                charts.serviceDetails.destroy();
            }
            
            createServiceOverviewChart();
            createDiabanChart();
            createServiceDetailsChart();
        }

        // Service Overview Pie Chart
        function createServiceOverviewChart() {
            const ctx = document.getElementById('serviceOverviewChart').getContext('2d');
            
            // Calculate totals for all status types (ch·ªâ 4 tr·∫°ng th√°i)
            let totalCo = 0, totalKhongCoNhuCau = 0, totalHopDongVNPT = 0, totalHopDongKhac = 0;
            
            Object.values(dashboardData.service_stats).forEach(service => {
                totalCo += service.co || 0;
                totalKhongCoNhuCau += service.khong_co_nhu_cau || 0;
                totalHopDongVNPT += service.hop_dong_vnpt || 0;
                totalHopDongKhac += service.hop_dong_khac || 0;
            });

            charts.serviceOverview = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: [
                        'C√≥', 
                        'Ch∆∞a c√≥ nhu c·∫ßu', 
                        'Hƒê v·ªõi VNPT', 
                        'Hƒê v·ªõi ƒë∆°n v·ªã kh√°c'
                    ],
                    datasets: [{
                        data: [
                            totalCo, 
                            totalKhongCoNhuCau, 
                            totalHopDongVNPT, 
                            totalHopDongKhac
                        ],
                        backgroundColor: [
                            '#10b981', // green - C√≥
                            '#ef4444', // red - Ch∆∞a c√≥ nhu c·∫ßu
                            '#3b82f6', // blue - Hƒê v·ªõi VNPT
                            '#8b5cf6'  // purple - Hƒê v·ªõi ƒë∆°n v·ªã kh√°c
                        ],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                usePointStyle: true,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.parsed} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Diaban Completion Rate Chart
        function createDiabanChart() {
            const ctx = document.getElementById('diabanChart').getContext('2d');
            
            const diabanStats = dashboardData.diaban_stats;
            const labels = Object.keys(diabanStats);
            const completionRates = labels.map(diaban => {
                const stats = diabanStats[diaban];
                // T√≠nh t·ª∑ l·ªá x√£/ph∆∞·ªùng ƒë√£ kh·∫£o s√°t / t·ªïng s·ªë x√£/ph∆∞·ªùng trong ƒë·ªãa b√†n
                return stats.total_areas > 0 ? (stats.surveyed_areas / stats.total_areas * 100).toFixed(1) : 0;
            });

            charts.diaban = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: completionRates,
                        backgroundColor: [
                            '#8b5cf6',
                            '#06b6d4', 
                            '#10b981',
                            '#f59e0b',
                            '#ef4444',
                            '#84cc16'
                        ],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const diaban = context.label;
                                    const stats = diabanStats[diaban];
                                    return `${diaban}: ${context.parsed}% (${stats.surveyed_areas}/${stats.total_areas} x√£/ph∆∞·ªùng)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Service Details Bar Chart
        function createServiceDetailsChart() {
            const ctx = document.getElementById('serviceDetailsChart').getContext('2d');
            
            const services = Object.values(dashboardData.service_stats);
            const labels = services.map(s => s.name);
            const coData = services.map(s => s.co || 0);
            const khongCoNhuCauData = services.map(s => s.khong_co_nhu_cau || 0);
            const hopDongVNPTData = services.map(s => s.hop_dong_vnpt || 0);
            const hopDongKhacData = services.map(s => s.hop_dong_khac || 0);

            charts.serviceDetails = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'C√≥',
                            data: coData,
                            backgroundColor: '#10b981',
                            borderColor: '#059669',
                            borderWidth: 1
                        },
                        {
                            label: 'Ch∆∞a c√≥ nhu c·∫ßu',
                            data: khongCoNhuCauData,
                            backgroundColor: '#ef4444',
                            borderColor: '#dc2626',
                            borderWidth: 1
                        },
                        {
                            label: 'Hƒê v·ªõi VNPT',
                            data: hopDongVNPTData,
                            backgroundColor: '#3b82f6',
                            borderColor: '#2563eb',
                            borderWidth: 1
                        },
                        {
                            label: 'Hƒê v·ªõi ƒë∆°n v·ªã kh√°c',
                            data: hopDongKhacData,
                            backgroundColor: '#8b5cf6',
                            borderColor: '#7c3aed',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                afterBody: function(context) {
                                    const datasetIndex = context[0].datasetIndex;
                                    const serviceIndex = context[0].dataIndex;
                                    const service = services[serviceIndex];
                                    
                                    // Hi·ªÉn th·ªã th√¥ng tin ƒë·∫∑c bi·ªát cho d·ªãch v·ª• 7 v√† 8
                                    if (serviceIndex + 1 === 7 && datasetIndex === 0) { // Camera x√£ ph∆∞·ªùng
                                        return 'Bao g·ªìm: H·∫πn l·ªãch kh·∫£o s√°t';
                                    } else if (serviceIndex + 1 === 8 && datasetIndex === 0) { // K√™nh TSL CD
                                        return 'Bao g·ªìm: S·ªë l∆∞·ª£ng k√™nh';
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'D·ªãch v·ª•'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 0
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'S·ªë l∆∞·ª£ng khu v·ª±c'
                            },
                            beginAtZero: true,
                            stacked: false
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    }
                }
            });
        }

        // Populate area table
        function populateAreaTable() {
            // Store original data and setup filters
            originalAreaData = [...dashboardData.area_details];
            filteredAreaData = [...originalAreaData];
            
            // Populate diaban filter options
            setupFilters();
            
            // Render table
            renderTable();
            
            // Setup event listeners for search and filter
            setupTableEventListeners();
        }

        // Setup filter options
        function setupFilters() {
            const diabanFilter = document.getElementById('diabanFilter');
            const diabans = [...new Set(originalAreaData.map(area => area.diaban))].sort();
            
            // Clear existing options (except first one)
            diabanFilter.innerHTML = '<option value="">T·∫•t c·∫£ ƒë·ªãa b√†n</option>';
            
            diabans.forEach(diaban => {
                const option = document.createElement('option');
                option.value = diaban;
                option.textContent = diaban;
                diabanFilter.appendChild(option);
            });
        }

        // Render table with current filtered data
        function renderTable() {
            const tbody = document.getElementById('areaTableBody');
            tbody.innerHTML = '';

            filteredAreaData.forEach((area, index) => {
                const row = document.createElement('tr');
                row.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                
                const completionClass = area.completion_rate >= 75 ? 'text-green-600 bg-green-100' : 
                                      area.completion_rate >= 50 ? 'text-yellow-600 bg-yellow-100' : 
                                      'text-red-600 bg-red-100';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${index + 1}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${area.area_name}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${area.diaban}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${area.completed_services}/12</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${completionClass}">
                            ${area.completion_rate}%
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="progress-bar h-2 rounded-full ${area.completion_rate >= 75 ? 'bg-green-500' : area.completion_rate >= 50 ? 'bg-yellow-500' : 'bg-red-500'}" 
                                 style="width: ${area.completion_rate}%"></div>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Update table stats
            updateTableStats();
        }

        // Update table statistics
        function updateTableStats() {
            const tableStats = document.getElementById('tableStats');
            tableStats.textContent = `Hi·ªÉn th·ªã ${filteredAreaData.length} / ${originalAreaData.length} k·∫øt qu·∫£`;
        }

        // Setup event listeners for table functionality
        function setupTableEventListeners() {
            // Search input
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', filterTable);
            
            // Filter dropdowns
            const diabanFilter = document.getElementById('diabanFilter');
            const completionFilter = document.getElementById('completionFilter');
            
            diabanFilter.addEventListener('change', filterTable);
            completionFilter.addEventListener('change', filterTable);
            
            // Clear filters button
            const clearFiltersBtn = document.getElementById('clearFilters');
            clearFiltersBtn.addEventListener('click', clearAllFilters);
        }

        // Filter table based on search and filter criteria
        function filterTable() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const selectedDiaban = document.getElementById('diabanFilter').value;
            const selectedCompletion = document.getElementById('completionFilter').value;
            
            filteredAreaData = originalAreaData.filter(area => {
                // Search filter
                const matchesSearch = searchTerm === '' || 
                    area.area_name.toLowerCase().includes(searchTerm) ||
                    area.diaban.toLowerCase().includes(searchTerm);
                
                // Diaban filter
                const matchesDiaban = selectedDiaban === '' || area.diaban === selectedDiaban;
                
                // Completion rate filter
                let matchesCompletion = true;
                if (selectedCompletion === 'high') {
                    matchesCompletion = area.completion_rate >= 75;
                } else if (selectedCompletion === 'medium') {
                    matchesCompletion = area.completion_rate >= 50 && area.completion_rate < 75;
                } else if (selectedCompletion === 'low') {
                    matchesCompletion = area.completion_rate < 50;
                }
                
                return matchesSearch && matchesDiaban && matchesCompletion;
            });
            
            // Apply current sort if any
            if (currentSortField) {
                sortFilteredData(currentSortField, currentSortDirection);
            }
            
            // Update active filters display
            updateActiveFilters();
            
            renderTable();
        }

        // Update active filters display
        function updateActiveFilters() {
            const searchTerm = document.getElementById('searchInput').value.trim();
            const selectedDiaban = document.getElementById('diabanFilter').value;
            const selectedCompletion = document.getElementById('completionFilter').value;
            
            const activeFiltersEl = document.getElementById('activeFilters');
            const filterBadgesEl = document.getElementById('filterBadges');
            
            let badges = [];
            
            if (searchTerm) {
                badges.push(`<span class="filter-badge">T√¨m ki·∫øm: "${searchTerm}" <button onclick="clearSearchFilter()">√ó</button></span>`);
            }
            
            if (selectedDiaban) {
                badges.push(`<span class="filter-badge">ƒê·ªãa b√†n: ${selectedDiaban} <button onclick="clearDiabanFilter()">√ó</button></span>`);
            }
            
            if (selectedCompletion) {
                const completionLabels = {
                    'high': 'Cao (‚â•75%)',
                    'medium': 'Trung b√¨nh (50-74%)',
                    'low': 'Th·∫•p (<50%)'
                };
                badges.push(`<span class="filter-badge">T·ª∑ l·ªá: ${completionLabels[selectedCompletion]} <button onclick="clearCompletionFilter()">√ó</button></span>`);
            }
            
            if (badges.length > 0) {
                filterBadgesEl.innerHTML = badges.join('');
                activeFiltersEl.classList.remove('hidden');
            } else {
                activeFiltersEl.classList.add('hidden');
            }
        }

        // Clear individual filters
        function clearSearchFilter() {
            document.getElementById('searchInput').value = '';
            filterTable();
        }

        function clearDiabanFilter() {
            document.getElementById('diabanFilter').value = '';
            filterTable();
        }

        function clearCompletionFilter() {
            document.getElementById('completionFilter').value = '';
            filterTable();
        }

        // Clear all filters
        function clearAllFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('diabanFilter').value = '';
            document.getElementById('completionFilter').value = '';
            
            filteredAreaData = [...originalAreaData];
            currentSortField = '';
            currentSortDirection = 'asc';
            
            renderTable();
        }

        // Sort table by field
        function sortTable(field) {
            // Toggle sort direction if same field, otherwise default to ascending
            if (currentSortField === field) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortField = field;
                currentSortDirection = 'asc';
            }
            
            sortFilteredData(field, currentSortDirection);
            updateSortHeaders();
            renderTable();
        }

        // Update sort header indicators
        function updateSortHeaders() {
            // Remove all active sort classes
            document.querySelectorAll('.sort-header').forEach(header => {
                header.classList.remove('active', 'asc', 'desc');
            });
            
            // Add active sort class to current field
            if (currentSortField) {
                const currentHeader = document.getElementById(`header-${currentSortField}`);
                if (currentHeader) {
                    currentHeader.classList.add('active', currentSortDirection);
                }
            }
        }

        // Sort the filtered data
        function sortFilteredData(field, direction) {
            filteredAreaData.sort((a, b) => {
                let valueA, valueB;
                
                switch (field) {
                    case 'area_name':
                        valueA = a.area_name.toLowerCase();
                        valueB = b.area_name.toLowerCase();
                        break;
                    case 'diaban':
                        valueA = a.diaban.toLowerCase();
                        valueB = b.diaban.toLowerCase();
                        break;
                    case 'completed_services':
                        valueA = a.completed_services;
                        valueB = b.completed_services;
                        break;
                    case 'completion_rate':
                        valueA = a.completion_rate;
                        valueB = b.completion_rate;
                        break;
                    default:
                        return 0;
                }
                
                if (direction === 'asc') {
                    return valueA < valueB ? -1 : valueA > valueB ? 1 : 0;
                } else {
                    return valueA > valueB ? -1 : valueA < valueB ? 1 : 0;
                }
            });
        }

        // Refresh data
        async function refreshData() {
            const refreshBtn = document.getElementById('refreshBtn');
            const refreshText = document.getElementById('refreshText');
            const refreshSpinner = document.getElementById('refreshSpinner');
            
            refreshBtn.disabled = true;
            refreshText.classList.add('hidden');
            refreshSpinner.classList.remove('hidden');
            
            try {
                // Destroy all charts before refreshing
                destroyAllCharts();
                await loadDashboardData();
                
                // Show success message
                Swal.fire({
                    icon: 'success',
                    title: 'Th√†nh c√¥ng!',
                    text: 'D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c l√†m m·ªõi.',
                    timer: 2000,
                    showConfirmButton: false
                });
            } catch (error) {
                console.error('Error refreshing data:', error);
            } finally {
                refreshBtn.disabled = false;
                refreshText.classList.remove('hidden');
                refreshSpinner.classList.add('hidden');
            }
        }

        // Event listeners
        document.getElementById('refreshBtn').addEventListener('click', refreshData);

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            loadDashboardData();
        });

        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // Auto refresh every 5 minutes
        setInterval(() => {
            loadDashboardData();
        }, 5 * 60 * 1000);
    </script>
</body>

</html>
