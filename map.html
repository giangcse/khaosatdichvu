<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bản đồ khảo sát – Vĩnh Long</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous" />
  <style>
    :root {
      --ok: #16a34a;
      /* xanh */
      --warn: #f59e0b;
      /* vàng */
      --bad: #ef4444;
      /* đỏ */
      --ink: #111827;
      /* text */
      --muted: #6b7280;
      /* subtext */
      --line: #e5e7eb;
      /* border */
      --bg: #ffffff;
    }
    html,
    body {
      height: 100%;
      margin: 0;
    }
    #map {
      height: 100vh;
      width: 100vw;
    }

    /* Loading overlay */
    .loading-overlay { position: fixed; inset: 0; display:flex; align-items:center; justify-content:center; background:rgba(255,255,255,.85); backdrop-filter: blur(2px); z-index: 2000; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .loading-card { display:flex; align-items:center; gap:12px; background:#fff; border-radius:14px; padding:14px 18px; box-shadow:0 10px 30px rgba(0,0,0,.12); }
    .spinner { width:22px; height:22px; border-radius:50%; border:3px solid #e5e7eb; border-top-color:#3b82f6; animation: spin .9s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg);} }
    .loading-text { font-size:14px; color:var(--ink); }
    .loading-sub { font-size:12px; color:var(--muted); margin-top:2px; }
    .hidden{ display:none !important; }

    /* Legend */
    .legend { position:absolute; right:12px; bottom:12px; z-index:1000; background:rgba(255,255,255,.96); padding:8px 10px; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,.12); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; font-size:12px; }
    .legend .row { display:flex; align-items:center; gap:6px; margin:4px 0; }
    .dot { width:10px; height:10px; border-radius:50%; display:inline-block; }

    /* Popup */
    .vl-popup { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; color: var(--ink); min-width: 480px; max-width: 600px; }
    .vl-popup h3 { margin:0; font-size:16px; line-height:1.2; }
    .vl-subrow { display:flex; align-items:center; gap:8px; margin-top:6px; color:var(--muted); font-size:13px; }
    .vl-divider { height:1px; background:var(--line); margin:8px 0; }
    .vl-count { color:var(--muted); font-size:13px; margin-bottom:6px; }
    .vl-list { max-height: 280px; overflow:auto; display:flex; flex-direction:column; gap:6px; padding-right:2px; }
    .vl-item { display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px 10px; border-radius:10px; border:1px solid var(--line); font-size:13px; }
    .vl-item.ok   { background:#ecfdf5; border-color:#bbf7d0; }
    .vl-item.warn { background:#fffbeb; border-color:#fde68a; }
    .vl-item.bad  { background:#fef2f2; border-color:#fecaca; }
    .vl-item .name { display:flex; align-items:center; gap:8px; font-weight:600; }
    .vl-item .value { white-space:nowrap; }
    .status-base {
      font-weight: 600;
      white-space: nowrap;
    }
    
    .status-detail {
      display: inline-block;
      margin-left: 4px;
      color: var(--muted);
      font-weight: normal;
      white-space: normal;   /* Cho phép xuống dòng nếu dài */
      max-width: 180px;      /* Giới hạn chiều rộng để text tự xuống hàng */
      word-break: break-word; /* Tự ngắt từ nếu quá dài */
    }
    
    .popup .dot { width:8px; height:8px; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="legend" id="legend">
    <div><strong>Chú giải (mức độ đủ dịch vụ)</strong></div>
    <div class="row"><span class="dot" style="background:var(--ok)"></span> Nhiều (≥ 9)</div>
    <div class="row"><span class="dot" style="background:var(--warn)"></span> Trung bình (5–8)</div>
    <div class="row"><span class="dot" style="background:var(--bad)"></span> Ít (≤ 4)</div>
    <div style="margin-top:6px;color:var(--muted)">Di chuột để highlight • Nhấp để xem chi tiết</div>
  </div>

  <div id="loading" class="loading-overlay" role="status" aria-live="polite">
    <div class="loading-card">
      <div class="spinner" aria-hidden="true"></div>
      <div>
        <div class="loading-text">Đang tải biên giới xã/phường…</div>
        <div class="loading-sub">Vui lòng đợi dữ liệu GeoJSON và nền bản đồ được tải xong.</div>
      </div>
    </div>
    </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/leaflet-providers@1.13.0/leaflet-providers.js"></script>
  <script>
            // ===== Map init =====
            const map = L.map('map', { preferCanvas: true });

            let initialLoading = true, tilesReady = false, geojsonReady = false;
            const loadingEl = document.getElementById('loading');
            const showLoading = (msg) => { if (!initialLoading) return; if (msg) loadingEl.querySelector('.loading-text').textContent = msg; loadingEl.classList.remove('hidden'); };
            const hideLoading = () => { loadingEl.classList.add('hidden'); initialLoading = false; };
            const maybeHide = () => { if (tilesReady && geojsonReady) hideLoading(); };

            const esri = L.tileLayer.provider('Esri.WorldImagery');
            const cartoLight = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 20, attribution: '&copy; OpenStreetMap & CARTO' });
            esri.on('loading', () => showLoading());
            esri.on('load', () => { tilesReady = true; maybeHide(); });
            esri.addTo(map);
            L.control.layers({ 'Esri World Imagery': esri, 'Carto Light': cartoLight }, {}, { position: 'topleft' }).addTo(map);

            // Zoom vào Vĩnh Long
            map.setView([10.00, 106.45], 10);

            let gjLayer = null, surveys = {};

            // ===== Helpers =====
            function normalizeName(s) {
              if (!s) return '';
              s = String(s).trim();
              const pfx = ['Xã ', 'Phường ', 'Thị trấn ', 'Thị xã ', 'xã ', 'phường ', 'thị trấn ', 'thị xã '];
              for (const p of pfx) { if (s.startsWith(p)) { s = s.slice(p.length).trim(); break; } }
              return s;
    }
            function statusColorByCount(n) {
              if (typeof n !== 'number') return '#93c5fd';
              if (n >= 9) return getComputedStyle(document.documentElement).getPropertyValue('--ok') || '#16a34a';
              if (n >= 5) return getComputedStyle(document.documentElement).getPropertyValue('--warn') || '#f59e0b';
              return getComputedStyle(document.documentElement).getPropertyValue('--bad') || '#ef4444';
            }
            function parseStatusText(raw) {
              const s = String(raw || '').trim();
              let base = s, detail = '';
              const open = s.indexOf('('), close = s.lastIndexOf(')');
              if (open >= 0 && close > open) { base = s.slice(0, open).trim(); detail = s.slice(open + 1, close).trim(); }
              if (/^có\b/i.test(base)) base = 'Có';
              else if (/^kh[oô]ng\b/i.test(base)) base = 'Không';
              else if (/^đang/i.test(base)) base = 'Đang triển khai';
              else if (/^chưa/i.test(base)) base = 'Chưa khảo sát';
              return { base, detail };
          }
            function escapeHtml(s) { return String(s).replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;').replaceAll("'", '&#039;'); }

            const SERVICE_NAMES = { 1: 'Biên lai điện tử', 2: 'Kiosk AI', 3: 'Kiosk bắt số', 4: 'Hội nghị TT', 5: 'Hệ thống Wifi', 6: 'Camera HCC', 7: 'Camera xã phường', 8: 'Kênh TSL CD', 9: 'AI cho CCVC', 10: 'Smart IR', 11: 'Firewall S-Gate', 12: 'VNPT Money' };
            function serviceClass(base) { if (base === 'Có') return 'ok'; if (base === 'Không') return 'bad'; if (base === 'Đang triển khai') return 'warn'; return ''; }

            function popupLoadingHtml(areaRaw) {
              const name = escapeHtml(areaRaw || '(không tên)');
              return `<div class="vl-popup"><h3>${name}</h3><div class="vl-subrow"><div class="spinner" style="width:16px;height:16px;border-width:2px;border-top-color:#16a34a"></div>Đang tải chi tiết…</div></div>`;
            }

            function popupErrorHtml(areaRaw, msg) {
              const name = escapeHtml(areaRaw || '(không tên)');
              return `<div class="vl-popup"><h3>${name}</h3><div class="vl-divider"></div><div class="vl-subrow" style="color:#b91c1c">${escapeHtml(msg || 'Không tải được dữ liệu')}</div></div>`;
            }

            function buildPopupFromApi(areaRaw, api) {
              const svList = api?.services || [];
              const completed = api?.statistics?.completed_services || 0;
              let listHtml = '';
              for (const it of svList) {
                const nm = SERVICE_NAMES[it.id] || it.name || (`Dịch vụ ${it.id}`);
                const { base, detail } = parseStatusText(it.status);
          
              // Logic màu sắc đặc biệt cho dịch vụ "Kênh TSL CD" (id = 8)
              let cls, dot;
              if (it.id === 8) { // Kênh TSL CD
                cls = base === 'Không' ? 'bad' : base === 'Có' ? 'ok' : base === 'Đang triển khai' ? 'warn' : '';
                dot = base === 'Không' ? 'var(--bad)' : base === 'Có' ? 'var(--ok)' : base === 'Đang triển khai' ? 'var(--warn)' : '#9ca3af';
              } else {
                cls = serviceClass(base);
                dot = base === 'Có' ? 'var(--ok)' : base === 'Không' ? 'var(--bad)' : base === 'Đang triển khai' ? 'var(--warn)' : '#9ca3af';
              }
            
              const valueHtml = `
              <div>
                <span class="status-base">${escapeHtml(base)}</span>
                ${detail ? `<div class="status-detail">${escapeHtml(detail)}</div>` : ''}
              </div>`;

              listHtml += `<div class="vl-item ${cls}"><div class="name"><span class="dot" style="background:${dot}"></span>${escapeHtml(nm)}</div><div class="value">${valueHtml}</div></div>`;
      }
            const name = escapeHtml(areaRaw || '(không tên)');
            return `
        <div class="vl-popup">
          <h3>${name}</h3>
          <div class="vl-divider"></div>
          <div class="vl-count">${completed}/12 dịch vụ</div>
          <div class="vl-list">${listHtml}</div>
        </div>`;
    }

            function countYesFromLocal(sv) {
              if (!sv) return 0; let n = 0; for (let i = 1; i <= 12; i++) { const { base } = parseStatusText(sv['dich_vu_' + i]); if (base === 'Có') n++; } return n;
      }

            function baseStyle(feat) {
              const p = feat?.properties || {};
              const name = normalizeName(p.TEN_XA || p.ten_xa || p.Name || p.name || p.xaphuong);
              const sv = surveys[name];
              const yes = countYesFromLocal(sv);
              return { color: '#1f2937', weight: 1, fillColor: sv ? statusColorByCount(yes) : '#3b82f6', fillOpacity: sv ? .75 : .25 };
    }

            function onEachFeature(feat, layer) {
              const p = feat?.properties || {};
              const rawName = p.TEN_XA || p.ten_xa || p.Name || p.name || p.xaphuong || '';
              const nameKey = normalizeName(rawName);

            // Bind a lightweight popup immediately (shows loading), then fetch API and replace content
            layer.bindPopup(popupLoadingHtml(rawName), { maxWidth: 480, className: 'popup' });

            layer.on({
              mouseover: e => { e.target.setStyle({ weight: 2, color: '#111827', fillOpacity: .8 }); },
              mouseout: e => { if (gjLayer) gjLayer.resetStyle(e.target); },
              click: e => {
                const b = e.target.getBounds?.(); if (b && b.isValid()) map.fitBounds(b, { padding: [20, 20] });
                e.target.openPopup();
                // Fire API call now
                const url = `/api/survey-details/${encodeURIComponent(nameKey)}`;
                fetch(url, { cache: 'no-store' })
                  .then(r => r.ok ? r.json() : r.json().catch(() => ({ success: false, message: r.statusText })).then(j => Promise.reject(j)))
                  .then(data => {
                    const html = buildPopupFromApi(rawName, data);
                    e.target.getPopup().setContent(html).update();
                  })
                  .catch(err => {
                    const msg = err?.message || err?.detail || err?.error || 'Không tải được chi tiết';
                    e.target.getPopup().setContent(popupErrorHtml(rawName, msg)).update();
                  });
              }
          });
    }

            function addGeoJsonToMap(data) {
              if (gjLayer) { map.removeLayer(gjLayer); gjLayer = null; }
              const opts = { style: baseStyle, onEachFeature };
              gjLayer = L.geoJSON(data, opts).addTo(map);
              geojsonReady = true; maybeHide();
    }

            async function loadAll() {
              try {
                const [gjRes, apiRes] = await Promise.all([
                  fetch('map.geojson', { cache: 'no-store' }),
                  fetch('/api/map-data', { cache: 'no-store' }).catch(() => null)
                ]);
                if (!gjRes.ok) throw new Error('Không đọc được map.geojson');
                const gj = await gjRes.json();
                const api = apiRes && apiRes.ok ? await apiRes.json() : null;
                surveys = api && api.surveys ? api.surveys : {};
                addGeoJsonToMap(gj);
              } catch (e) {
                console.error(e);
                loadingEl.querySelector('.loading-text').textContent = 'Lỗi khi tải dữ liệu bản đồ';
                loadingEl.querySelector('.loading-sub').textContent = 'Kiểm tra lại map.geojson và API /api/map-data.';
              }
    }

            // init
            esri.on('load', () => { tilesReady = true; maybeHide(); });
            loadAll();
  </script>
</body>
</html>