<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>VN + Hoàng Sa + Trường Sa — Leaflet + Providers</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    html, body, #map { height: 100%; margin: 0; }
    .legend {
      background: #fff; padding: 8px 10px; border-radius: 6px;
      box-shadow: 0 1px 4px rgba(0,0,0,.2); font: 13px/1.2 system-ui, sans-serif;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <!-- Leaflet Providers (leaflet-extras/leaflet-providers) -->
  <script src="https://unpkg.com/leaflet-providers@1.13.0/leaflet-providers.js"></script>

  <script>
    // 1) Khởi tạo bản đồ
    const map = L.map('map', {
      center: [16, 108],
      zoom: 5,
      minZoom: 3,
      worldCopyJump: true
    });

    // 2) Base layers qua leaflet-providers
    const esriWorldImagery = L.tileLayer.provider('Esri.WorldImagery'); // như bạn yêu cầu
    const osm = L.tileLayer.provider('OpenStreetMap.Mapnik');
    const cartoLight = L.tileLayer.provider('CartoDB.Positron');

    // Mặc định dùng Esri.WorldImagery
    esriWorldImagery.addTo(map);

    // 3) Tạo control để đổi nền
    const baseLayers = {
      "Esri WorldImagery": esriWorldImagery,
      "OpenStreetMap": osm,
      "Carto Light": cartoLight
    };

    // 4) Style/interaction cho GeoJSON
    const defaultStyle = {
      color: "#1565c0",
      weight: 1,
      fillColor: "#42a5f5",
      fillOpacity: 0.25
    };

    function highlightStyle(e) {
      const layer = e.target;
      layer.setStyle({ weight: 2, fillOpacity: 0.35 });
      if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
        layer.bringToFront();
      }
    }

    function resetHighlight(e) {
      geojson.resetStyle(e.target);
    }

    function onEachFeature(feature, layer) {
      // Tên thuộc tính tùy file của bạn: thử các key thường gặp
      const props = feature.properties || {};
      const name =
        props.name || props.NAME || props.Name ||
        props.ten || props.Ten || props.TEN ||
        props['ten_xa'] || props['ten_huyen'] || 'Không rõ tên';
      layer.bindTooltip(name, { sticky: true });

      layer.on({
        mouseover: highlightStyle,
        mouseout: resetHighlight,
        click: (e) => {
          const b = e.target.getBounds();
          map.fitBounds(b.pad(0.2));
        }
      });
    }

    let geojson;

    // 5) Load GeoJSON bạn cung cấp (đặt file ở cùng thư mục, đổi path nếu cần)
    fetch('vinhlong_hoangsa_truongsa.geojson')
      .then(r => {
        if (!r.ok) throw new Error('Không đọc được GeoJSON: ' + r.status);
        return r.json();
      })
      .then(data => {
        geojson = L.geoJSON(data, {
          style: defaultStyle,
          onEachFeature
        }).addTo(map);

        // 6) Fit đến toàn bộ VN (kể cả HS/TS)
        try {
          map.fitBounds(geojson.getBounds().pad(0.05));
        } catch (e) {
          console.warn('Không fitBounds được, dùng view mặc định.', e);
        }

        // 7) Thêm layer control
        L.control.layers(baseLayers, { "Biên giới (GeoJSON)": geojson }, { collapsed: false }).addTo(map);

        // 8) Thêm chú giải nhỏ
        const legend = L.control({ position: 'bottomleft' });
        legend.onAdd = function () {
          const div = L.DomUtil.create('div', 'legend');
          div.innerHTML = `
            <div><b>Việt Nam</b></div>
            <div>• Biên giới: ${defaultStyle.color}</div>
            <div>• Nền: Esri WorldImagery</div>
            <div>• Đã bao gồm Hoàng Sa & Trường Sa</div>
          `;
          return div;
        };
        legend.addTo(map);
      })
      .catch(err => {
        console.error(err);
        alert('Lỗi khi load GeoJSON. Kiểm tra tên file/path hoặc chạy qua HTTP server.');
      });
  </script>
</body>
</html>
